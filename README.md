# Сервис для анализа временных рядов

## TODO

- список рядов + загрузка (присвоение имени ряду - пользователем + время загрузки)
- ссылка на страницу с историей транзакций

- обновить структуру проекта
- рассказать что должно лежать в .env

## Принцип работы

- Пользователь регистрируется/авторизуется.
- Пользователь загружает свой временной ряд.
- Пользователь может сделать статистический анализ временного ряда.
- Пользователь может получить предсказания будущих значений, выбрав подходящую модель.
- У пользователя есть баланс, с которого будут списаны средства за анализ или предсказание.
- Пользователь может скачать предобработанный временной ряд или предсказанные значения.

## Демо

TODO

Сюда вставить скриншоты интерфейса, баз данных, а также ссылку на видео-демо.

## Компоненты системы

- Регистрация/аутентификация.
- Биллинг.
- Загрузка/скачивание временных рядов.
- Анализ временного ряда.
- Предсказание временного ряда.
- Интерфейс.

### Регистрация/аутентификация

Регистрация/аутентификация пользователя по логину и паролю.

Данный модуль реализован с помощью `FastAPI.security`, а именно используя парадингму OAuth2 на основе классов `OAuth2PasswordBearer`, `OAuth2PasswordRequestForm`. Делал я это по этим [официальным докам FastAPI](https://fastapi.tiangolo.com/tutorial/security/).

Принцип работы: 

- У меня есть бекенд (с различными эндпоинтами, реализованный через `FastAPI`) и фронтенд (реализованный на `streamlit`).
- В данном конкретном случае (т.н. *password flow в OAuth2*) бекенд будет как реализовывать API, так и проводить аутентификацию пользователя.
- Итак, алгоритм:
  - Пользователь вводит логин и пароль на фронтенде.
  - Фронтенд отправляет их в бекенд API.
  - Бекенд API проверяет данные и возвращает токен - строку, подтверждающую пользователя. Токен имеет некоторый lifetime. В качестве токена использую JWT (с помощью библиотеки `PyJWT`).
  - Фронтенд временно сохраняет токен.
  - При переходе на другую часть приложения фронтенд запрашивает данные у API и для авторизации отправляет в заголовке к запросу этот токен.
  - Бекенд API проверяет токен и если он действителен, то отдает данные.

Пароли хэшировать буду с помощью библиотеки `passlib`, используя алгоритм `Bcrypt`.

Для того, чтобы создавались секьюрные JWT необходимо создать secure random secret key с помощью этой команды:

```bash
openssl rand -hex 32
```

Результатом будет строка, которую требуется положить в файл `.env` с названием SECRET_KEY.

### Биллинг

У каждого пользователя есть баланс, который проверяется при попытке пользователя сделать анализ/предсказание по загруженному временному ряду.

Пополнение баланса сделано искусственное (пользователь может ввести любую сумму и баланс пополнится).

### Загрузка/скачивание временных рядов

При загрузке пользователем временного ряда, данные проверяются на следование формату, пропуски и размеры. Если ряд удовлетворяет всем требованиям, то он сохраняется в базе данных (таблица `ts`).

Также есть возможность загружать временные ряды из базы данных.

### Анализ временного ряда

Данный модуль будет проводить действия:

- Построение графиков:

  - Исходный временной ряд.
  - Сглаженный временной ряд (exponential moving average). Также есть возможность скачать этот вариант ряда.

- Расчет простых статистик:

  - Среднее, медиана, стандартное отклонение, 25-й и 75-й квартили.
  - Минимальное и максимальное значения.
  - 3 наиболее и наименее частотные значения.

- Частотный анализ - наиболее значимые частоты используя преобразования Фурье.
- Статистические тесты:

  - Тест Манна-Кендалла на проверку наличия тренда. Также отобразим линейный тренд на исходном временном ряде.
  - Тест ARCH на проверку гетероскедастичности ряда. Также построим график остатков временного ряда от линейного тренда.

### Предсказание временного ряда

Данный модуль будет обучать статистические модели для предсказания временных рядов.

Все модели реализованы в библиотеке `statsforecast`:

- Модель экспоненциального скользящего среднего (ETS).
- Модель ARIMA.
- Модель Theta.
- Модель TBATS.

Также дадим предсказания наивными моделями:

- Модель среднего.
- Модель линейного тренда.

Предсказанные временные ряды и модели будут сохранены в базе данных (таблицы `series` и `trained_models`), отображены в интерфейсе, а также доступны для скачивания.

### Интерфейс

Использую библиотеку `streamlit` для построения интерфейса.

## Дизайн сервиса

### Бекенд

Весь бекэнд реализую с помощью `FastAPI` - это позволит обрабатывать все запросы к эндпоинтам (запросы на анализ и предсказание временного ряда будут попадать в очередь задач, чтобы не блокировать FastAPI клиент) в асинхронном режиме.

### Очереди задач для долгих вычислений

Использование очереди задач для анализа и предсказания нам нужны, чтобы не блокировать наш FastAPI клиент (будем ждать пока запрос посчитается). Поэтому при запросе на анализ/предсказание мы будем делать так:

- Эндпоинт принимает запрос в обработку и сразу возвращает task_id.
- Воркеры выбирают задачи, выполняют их и обновляют статус/результаты в базе данных.
- Интерфейс может опрашивать серверную часть для получения статуса задачи.

Соответственно для реализации этого использую:

- `Celery` - для создание процессов, которые будут выполнять тяжелые задачи (анализ временного ряда, обучение модели и предсказание будущих значений временного ряда) вне процесса FastAPI (чтобы его не блокировать).
- `Redis` - в качестве очереди задач (эндпоинт складывает задачу в очередь, на которую подписаны воркеры Celery).

### Работа с данными

Для хранения данных буду использовать in-memory БД `SQLite`, а для работы с БД библиотеку `SQLAlchemy`.

Соответственно есть следующие модели данных в виде таблиц:

- users: id, login, hashed_password, name, balance, time_series - данные о пользователях.
- ts: id, user_id, data - данные о временных рядах.

- models: model_id, name, info - данные о имеющихся моделях (название и описание).
- tariffs: model_id, price - данные о стоимости использования модели для предсказания временного ряда.
- stats: id, series_id, mean, mode, std, q25, q75, min, max, most_frequent, least_frequent, hist, smoothed, fourier_freqs, trend_test_pval, trend, het_test_pval, residuals - данные со статистиками, полученные при анализе временного ряда.
- trained_models: id, series_id, model_id, model_object - обученные модели на временных рядах (модель будем хранить как binary blob, полученный с помощью joblib).
- predictions: id, model_id, series_id, data - временной ряд с предсказаниями.

Для хранения задач (для воркеров Celery) будем использовать следующую модель данных:

- tasks: id, user_id, type, status, result, created_at, updated_at.

## Структура проекта

```
├── Project requirements.md
├── python-version
├── README.md
├── requirements.txt
└── src
    ├── analyze.py - модуль для анализа временного ряда
    ├── app.py - модуль с определением эндпоинтов FastAPI
    ├── contracts.py - контракты API
    ├── data
    │   └── models_info.json - информация о моделях (загружается в БД при запуске проекта)
    ├── data_models.py - модели данных ЬД
    ├── db.py - модуль для работы с БД (создание таблиц, загрузка данных в БД, получение данных из БД, создание сессии)
    ├── forecast.py - модуль для предсказания временного ряда
    ├── frontend.py - фронтенд на `streamlit`
    ├── security.py - модуль для работы с JWT токенами и хеширования паролей
    └── validate_series.py - модуль для валидации временного ряда
```

## Пример dotenv файла

```
# JWT settings
SECRET_KEY=RANDOM_SECRET_KEY
ALGORITHM=HS256
ACESS_TOKEN_EXPIRE_MINUTES=30
```

## Локальный запуск проекта

TODO